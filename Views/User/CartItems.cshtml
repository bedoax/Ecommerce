@model IEnumerable<Ecommerce.Models.Item>
@Html.Partial("Header")

<div class="container mt-5">
    <h2 class="text-center mb-4">Shopping Cart</h2>
    <div class="row">
        <!-- Shopping Cart Section -->
        <div class="col-lg-8" id="cart-section">
            @if (@ViewBag.CartItemsNumber > 0)
            {
                @foreach (var cartItem in Model)
                {
                    <div class="card mb-3 shadow-sm border-0 cart-item" data-item-id="@cartItem.Id" data-item-price="@cartItem.Price">
                        <div class="row no-gutters">
                            <div class="col-md-4">
                                <img src="~/images/@($"{cartItem.Id}_{cartItem.Name}.jpg")" class="card-img" alt="@cartItem.Name" style="object-fit: cover; height: 100%; border-radius: 8px;">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body d-flex flex-column justify-content-between">
                                    <div>
                                        <h5 class="card-title">@cartItem.Name</h5>
                                        <p class="card-text text-muted">k+ bought in the past month</p>
                                        <p class="text-success font-weight-bold">In Stock</p>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <p class="mb-0 font-weight-bold">$@cartItem.Price</p>
                                        </div>
                                        <a href="#" class="btn btn-outline-danger btn-sm delete">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <div class="card mt-4 shadow-sm border-0" id="order-summary">
                    <div class="card-body">
                        <h4 class="card-title">Order Summary</h4>
                        <hr>
                        <p class="card-text">Total Price: $<span id="totalPrice">@ViewBag.TotalPrice</span></p>
                        <button id="purchaseButton" class="btn btn-success btn-lg btn-block">Check Out</button>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center mt-5" id="empty-cart-message">
                    <h4>Your cart is currently empty.</h4>
                    <p class="text-muted">It looks like you haven't added anything to your cart yet.</p>
                    <a asp-action="Index" asp-controller="User" class="btn btn-primary" id="">Continue Shopping</a>
                </div>
            }
        </div>

        <!-- Suggested Products Section -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title">You may also like</h5>
                    <ul class="list-unstyled">
                        @foreach (var item in @ViewBag.OtherItems)
                        {
                            <div class="card mb-3 shadow-sm border-0">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title mb-1">@item.Name</h6>
                                        <p class="mb-0 font-weight-bold">$@item.Price</p>
                                    </div>
                                    <a href="@Url.Action("Details", "Item", new { id = item.Id })" class="btn btn-outline-dark btn-sm">Details</a>
                                </div>
                            </div>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let cartNumbers = document.getElementById("cart-count");
            let totalPriceElement = document.getElementById("totalPrice");

            if (!totalPriceElement) {
                console.error("Total Price element not found");
                return;
            }

            document.addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('delete')) {
                    e.preventDefault();
                    let itemId = e.target.closest('.cart-item').dataset.itemId;

                    $.ajax({
                        type: "POST",
                        url: '/Item/RemoveFromCart',
                        data: { id: itemId },
                        success: function (response) {
                            if (response.success) {
                                let cartItemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                                if (cartItemElement) {
                                    cartItemElement.remove();
                                    if (cartNumbers) {
                                        let currentCount = parseInt(cartNumbers.textContent) || 0;
                                        cartNumbers.textContent = currentCount - 1;
                                    }
                                    totalPriceElement.textContent = response.totalPrice.toFixed(2);

                                    // Check if the cart is empty after removing the item
                                    if (document.querySelectorAll('.cart-item').length === 0) {
                                        document.getElementById('order-summary').remove();
                                        document.getElementById('cart-section').innerHTML = `
                                                    <div class="text-center mt-5">
                                                        <h4>Your cart is currently empty.</h4>
                                                        <p class="text-muted">It looks like you haven't added anything to your cart yet.</p>
                                                        <a href = "@Url.Action("Index", "User")" class="btn btn-primary" id = "continueShopping">Continue Shopping</a>
                                                    </div>
                                                `;
                                    }
                                } else {
                                    console.error("Cart item element not found");
                                }
                            } else {
                                alert("Failed to delete item from cart. Please try again.");
                            }
                        },
                        error: function () {
                            alert("Error processing your request.");
                        }
                    });
                }
            });

            document.getElementById('purchaseButton').addEventListener('click', function () {
                window.location.href = '@Url.Action("Index", "Checkout")';
            });
        });
    </script>
}
